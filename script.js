/* ===== DATASETS ===== */
const datasets = {
    ru: [
{ q: "Ð¸", a: "and" },
{ q: "Ð²", a: "in" },
{ q: "Ð½Ðµ", a: "not" },
{ q: "Ð½Ð°", a: "on" },
{ q: "Ñ", a: "I" },
{ q: "Ð¾Ð½", a: "he" },
{ q: "Ñ‡Ñ‚Ð¾", a: "what" },
{ q: "Ñ", a: "with" },
{ q: "ÑÑ‚Ð¾", a: "this" },
{ q: "Ð±Ñ‹Ñ‚ÑŒ", a: "to be" },
{ q: "Ð°", a: "but" },
{ q: "Ð²ÐµÑÑŒ", a: "all" },
{ q: "Ð¾Ð½Ð¸", a: "they" },
{ q: "Ð¾Ð½Ð°", a: "she" },
{ q: "ÐºÐ°Ðº", a: "how" },
{ q: "Ð¼Ñ‹", a: "we" },
{ q: "Ðº", a: "to" },
{ q: "Ñƒ", a: "at" },
{ q: "Ð²Ñ‹", a: "you" },
{ q: "ÑÑ‚Ð¾Ñ‚", a: "this" },
{ q: "Ð·Ð°", a: "for" },
{ q: "Ñ‚Ð¾Ñ‚", a: "that" },
{ q: "Ð½Ð¾", a: "but" },
{ q: "Ñ‚Ñ‹", a: "you" },
{ q: "Ð¿Ð¾", a: "along" },
{ q: "Ð¸Ð·", a: "from" },
{ q: "Ð¾", a: "about" },
{ q: "ÑÐ²Ð¾Ð¹", a: "own" },
{ q: "Ñ‚Ð°Ðº", a: "so" },
{ q: "Ð¾Ð´Ð¸Ð½", a: "one" },
{ q: "Ð²Ð¾Ñ‚", a: "here" },
{ q: "ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¹", a: "which" },
{ q: "Ð½Ð°Ñˆ", a: "our" },
{ q: "Ñ‚Ð¾Ð»ÑŒÐºÐ¾", a: "only" },
{ q: "ÐµÑ‰Ñ‘", a: "still" },
{ q: "Ð¾Ñ‚", a: "from" },
{ q: "Ñ‚Ð°ÐºÐ¾Ð¹", a: "such" },
{ q: "Ð¼Ð¾Ñ‡ÑŒ", a: "can" },
{ q: "Ð³Ð¾Ð²Ð¾Ñ€Ð¸Ñ‚ÑŒ", a: "speak" },
{ q: "ÑÐºÐ°Ð·Ð°Ñ‚ÑŒ", a: "say" },
{ q: "Ð´Ð»Ñ", a: "for" },
{ q: "ÑƒÐ¶Ðµ", a: "already" },
{ q: "Ð·Ð½Ð°Ñ‚ÑŒ", a: "know" },
{ q: "Ð´Ð°", a: "yes" },
{ q: "ÐºÐ°ÐºÐ¾Ð¹", a: "which" },
{ q: "ÐºÐ¾Ð³Ð´Ð°", a: "when" },
{ q: "Ð´Ñ€ÑƒÐ³Ð¾Ð¹", a: "other" },
{ q: "Ð¿ÐµÑ€Ð²Ñ‹Ð¹", a: "first" },
{ q: "Ñ‡Ñ‚Ð¾Ð±Ñ‹", a: "to" },
{ q: "ÐµÐ³Ð¾", a: "his" },
{ q: "Ð³Ð¾Ð´", a: "year" },
{ q: "ÐºÑ‚Ð¾", a: "who" },
{ q: "Ð´ÐµÐ»Ð¾", a: "business" },
{ q: "Ð½ÐµÑ‚", a: "no" },
{ q: "ÐµÑ‘", a: "her" },
{ q: "Ð¾Ñ‡ÐµÐ½ÑŒ", a: "very" },
{ q: "Ð±Ð¾Ð»ÑŒÑˆÐ¾Ð¹", a: "big" },
{ q: "Ð½Ð¾Ð²Ñ‹Ð¹", a: "new" },
{ q: "Ñ€Ð°Ð±Ð¾Ñ‚Ð°", a: "work" },
{ q: "ÑÐµÐ¹Ñ‡Ð°Ñ", a: "now" },
{ q: "Ð²Ñ€ÐµÐ¼Ñ", a: "time" },
{ q: "Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº", a: "person" },
{ q: "Ð¸Ð´Ñ‚Ð¸", a: "go" },
{ q: "ÐµÑÐ»Ð¸", a: "if" },
{ q: "Ð´Ð²Ð°", a: "two" },
{ q: "Ð¼Ð¾Ð¹", a: "my" },
{ q: "Ð¶Ð¸Ð·Ð½ÑŒ", a: "life" },
{ q: "Ð´Ð¾", a: "until" },
{ q: "Ð³Ð´Ðµ", a: "where" },
{ q: "ÐºÐ°Ð¶Ð´Ñ‹Ð¹", a: "each" },
{ q: "ÑÐ°Ð¼Ñ‹Ð¹", a: "most" },
{ q: "Ñ…Ð¾Ñ‚ÐµÑ‚ÑŒ", a: "want" },
{ q: "Ð·Ð´ÐµÑÑŒ", a: "here" },
{ q: "Ð½Ð°Ð´Ð¾", a: "need" },
{ q: "Ð»ÑŽÐ´Ð¸", a: "people" },
{ q: "Ñ‚ÐµÐ¿ÐµÑ€ÑŒ", a: "now" },
{ q: "Ð´Ð¾Ð¼", a: "house" },
{ q: "Ñ€Ð°Ð·", a: "time" },
{ q: "Ð´ÐµÐ½ÑŒ", a: "day" },
{ q: "Ð¸Ð»Ð¸", a: "or" },
{ q: "Ð³Ð¾Ñ€Ð¾Ð´", a: "city" },
{ q: "Ñ‚Ð°Ð¼", a: "there" },
{ q: "ÑÐ»Ð¾Ð²Ð¾", a: "word" },
{ q: "Ð³Ð»Ð°Ð·", a: "eye" },
{ q: "Ð¿Ð¾Ñ‚Ð¾Ð¼", a: "then" },
{ q: "Ð²Ð¸Ð´ÐµÑ‚ÑŒ", a: "see" },
{ q: "Ð¸Ñ…", a: "their" },
{ q: "Ð¿Ð¾Ð´", a: "under" },
{ q: "Ð´Ð°Ð¶Ðµ", a: "even" },
{ q: "Ð´ÑƒÐ¼Ð°Ñ‚ÑŒ", a: "think" },
{ q: "Ñ…Ð¾Ñ€Ð¾ÑˆÐ¾", a: "well" },
{ q: "Ð¼Ð¾Ð¶Ð½Ð¾", a: "possible" },
{ q: "Ñ‚ÑƒÑ‚", a: "here" },
{ q: "Ñ‚Ñ‹ÑÑÑ‡Ð°", a: "thousand" },
{ q: "Ð»Ð¸", a: "whether" },
{ q: "Ð²Ð¾Ð´Ð°", a: "water" },
{ q: "Ð½Ð¸Ñ‡ÐµÐ³Ð¾", a: "nothing" },
{ q: "Ð¼Ð½Ð¾Ð³Ð¾", a: "many" },
{ q: "Ñ€ÑƒÐºÐ°", a: "hand" },
{ q: "ÑÐµÐ±Ñ", a: "self" },
{ q: "Ð¼Ð¾Ð»Ð¾Ð´Ð¾Ð¹", a: "young" },
{ q: "Ñ‚Ð¾Ð¶Ðµ", a: "too" },
{ q: "ÑÐ¿Ñ€Ð°ÑˆÐ¸Ð²Ð°Ñ‚ÑŒ", a: "ask" },
{ q: "Ð±ÐµÐ·", a: "without" },
{ q: "Ð´ÐµÐ»Ð°Ñ‚ÑŒ", a: "do" },
{ q: "Ñ‚Ñ€Ð¸", a: "three" },
{ q: "Ð²ÑÑ‘", a: "all" },
{ q: "Ñ‚Ð¾", a: "that" },
{ q: "Ð¶Ð¸Ñ‚ÑŒ", a: "live" },
{ q: "Ñ‚Ñ€ÑƒÐ´", a: "work" },
{ q: "ÑÐ°Ð¼", a: "self" },
{ q: "Ñ…Ð¾Ñ€Ð¾ÑˆÐ¸Ð¹", a: "good" },
{ q: "Ð²Ñ‚Ð¾Ñ€Ð¾Ð¹", a: "second" },
{ q: "Ñ‡ÐµÑ€ÐµÐ·", a: "through" },
{ q: "Ð¼ÐµÑÑ‚Ð¾", a: "place" },
{ q: "Ð¿Ð¾ÑÐ»Ðµ", a: "after" },
{ q: "ÑÑ‚Ñ€Ð°Ð½Ð°", a: "country" },
{ q: "Ð´Ð²Ð°Ð´Ñ†Ð°Ñ‚ÑŒ", a: "twenty" },
{ q: "Ð´Ð¾Ð»Ð¶ÐµÐ½", a: "must" },
{ q: "Ð±Ð¾Ð»ÑŒÑˆÐµ", a: "more" },
{ q: "Ð²Ð°Ñˆ", a: "your" },
{ q: "Ð´Ð²ÐµÑ€ÑŒ", a: "door" },
{ q: "Ð´Ñ€ÑƒÐ³", a: "friend" },
{ q: "Ð¼Ð°ÑˆÐ¸Ð½Ð°", a: "car" },
{ q: "ÐºÐ¾Ð¼Ð½Ð°Ñ‚Ð°", a: "room" },
{ q: "ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ", a: "study" },
{ q: "Ð½Ð°Ð´", a: "above" },
{ q: "Ð³Ð¾Ð»Ð¾Ð²Ð°", a: "head" },
{ q: "Ð¿Ð¾Ñ‡ÐµÐ¼Ñƒ", a: "why" },
{ q: "Ð·ÐµÐ¼Ð»Ñ", a: "earth" },
{ q: "ÑÑ‚Ð¾Ð»", a: "table" },
{ q: "Ð´Ð°Ð²Ð°Ñ‚ÑŒ", a: "give" },
{ q: "Ð¿ÐµÑ€ÐµÐ´", a: "before" },
{ q: "Ñ‚Ð¾Ð³Ð´Ð°", a: "then" },
{ q: "ÑÐ¸Ð´ÐµÑ‚ÑŒ", a: "sit" },
{ q: "Ð¼Ð°Ð»ÑŒÑ‡Ð¸Ðº", a: "boy" },
{ q: "Ð´ÐµÐ²ÑƒÑˆÐºÐ°", a: "girl" },
{ q: "Ð»ÐµÑ‚Ð¾", a: "summer" },
{ q: "ÑÐµÐ³Ð¾Ð´Ð½Ñ", a: "today" },
{ q: "ÑÑ‚Ð¾Ñ€Ð¾Ð½Ð°", a: "side" },
{ q: "ÑÐ¾Ð²ÑÐµÐ¼", a: "completely" },
{ q: "Ð¼Ð°Ð»ÐµÐ½ÑŒÐºÐ¸Ð¹", a: "small" },
{ q: "Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾", a: "several" },
{ q: "Ð²Ð´Ñ€ÑƒÐ³", a: "suddenly" },
{ q: "Ð»Ð¸Ñ†Ð¾", a: "face" },
{ q: "ÐºÐ¾Ð½ÐµÑ‡Ð½Ð¾", a: "of course" },
{ q: "Ð½Ð°Ñ€Ð¾Ð´", a: "people" },
{ q: "Ð½Ð°Ñ‡Ð¸Ð½Ð°Ñ‚ÑŒ", a: "begin" },
{ q: "Ð¿ÑÑ‚ÑŒ", a: "five" },
{ q: "Ð²ÐµÐ´ÑŒ", a: "after all" },
{ q: "Ð²Ð¾Ð¿Ñ€Ð¾Ñ", a: "question" },
{ q: "Ð¿Ð¸ÑÐ°Ñ‚ÑŒ", a: "write" },
{ q: "Ð¿Ð¸ÑÑŒÐ¼Ð¾", a: "letter" },
{ q: "Ð¿Ñ€Ð¸", a: "at" },
{ q: "Ð¼Ð°Ñ‚ÑŒ", a: "mother" },
{ q: "Ð½ÑƒÐ¶Ð½Ð¾", a: "necessary" },
{ q: "ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ", a: "watch" },
{ q: "ÑÐ¸Ð»Ð°", a: "strength" },
{ q: "Ð²Ð¼ÐµÑÑ‚Ðµ", a: "together" },
{ q: "Ð²Ñ‹Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ", a: "go out" },
{ q: "Ð»ÑŽÐ±Ð¸Ñ‚ÑŒ", a: "love" },
{ q: "Ð´Ð¾Ñ€Ð¾Ð³Ð°", a: "road" },
{ q: "ÑÑ‚Ð°Ñ€Ñ‹Ð¹", a: "old" },
{ q: "ÑƒÐ»Ð¸Ñ†Ð°", a: "street" },
{ q: "Ñ€ÐµÑˆÐ°Ñ‚ÑŒ", a: "decide" },
{ q: "ÐºÐ½Ð¸Ð³Ð°", a: "book" },
{ q: "Ð²ÑÐµÐ³Ð´Ð°", a: "always" },
{ q: "Ð³Ð¾Ð»Ð¾Ñ", a: "voice" },
{ q: "Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÑŒ", a: "mean" },
{ q: "ÑÑ€Ð°Ð·Ñƒ", a: "immediately" },
{ q: "Ð»Ð¸ÑˆÑŒ", a: "only" },
{ q: "Ð¼Ð¸Ð½ÑƒÑ‚Ð°", a: "minute" },
{ q: "ÑÐ½Ð¾Ð²Ð°", a: "again" },
{ q: "Ð¾ÐºÐ½Ð¾", a: "window" },
{ q: "Ð±Ñ‹", a: "would" },
{ q: "ÑƒÑ…Ð¾Ð´Ð¸Ñ‚ÑŒ", a: "leave" },
{ q: "Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹", a: "last" },
{ q: "Ð¿Ñ€Ð¾Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒ", a: "pass" },
{ q: "Ð¾Ñ‚ÐµÑ†", a: "father" },
{ q: "Ñ‡Ð°Ñ", a: "hour" },
{ q: "Ð¿Ñ€Ð¾ÑÑ‚Ð¾", a: "simply" },
{ q: "Ð¶Ðµ", a: "emphasis" },
{ q: "Ñ‚Ñ€ÐµÑ‚Ð¸Ð¹", a: "third" },
{ q: "Ð¿Ð¾Ñ‚Ð¾Ð¼Ñƒ", a: "because" },
{ q: "Ð½Ð¸ÐºÑ‚Ð¾", a: "nobody" },
{ q: "Ð¶Ð´Ð°Ñ‚ÑŒ", a: "wait" },
{ q: "ÑÐºÐ¾Ð»ÑŒÐºÐ¾", a: "how much" },
{ q: "Ð²Ñ‹ÑÐ¾ÐºÐ¸Ð¹", a: "tall" },
{ q: "Ð»ÑƒÑ‡ÑˆÐµ", a: "better" },
{ q: "Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ", a: "get" },
{ q: "Ð¿Ð¾Ñ‡Ñ‚Ð¸", a: "almost" },
{ q: "Ð»ÐµÑ", a: "forest" },
{ q: "ÐºÐ¾Ð½ÐµÑ†", a: "end" },
{ q: "Ð½Ð¾Ð³Ð°", a: "leg" },
{ q: "ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹", a: "own" },
{ q: "ÑÑ‚Ð¾", a: "hundred" }
    ],
    jp: [
        { q: "ç§", a: "I" }, { q: "çŒ«", a: "cat" }, { q: "çŠ¬", a: "dog" },
        { q: "é£Ÿã¹ã‚‹", a: "eat" }, { q: "è¦‹ã‚‹", a: "see" }, { q: "æœ¬", a: "book" },
        { q: "æ°´", a: "water" }, { q: "ç©º", a: "sky" }, { q: "å·", a: "river" },
        { q: "å±±", a: "mountain" }, { q: "ã¯ã„", a: "yes" }, { q: "ã„ã„ãˆ", a: "no" },
        { q: "è»Š", a: "car" }, { q: "é›»è©±", a: "phone" }, { q: "è¡Œã", a: "go" }
    ]
};

/* ===== STATE ===== */
let currentLang = "ru";
let mode = "normal";
let index = 0;
let revealed = false;
let activeCards = [];
let randomOrder = [];
let knownSet = new Set();

/* ===== ELEMENTS ===== */
const card = document.getElementById("card");
const fromInput = document.getElementById("from");
const toInput = document.getElementById("to");
const skipBtn = document.getElementById("skipBtn");
const resetBtn = document.getElementById("resetBtn");
const answerInput = document.getElementById("answerInput");
const langSelect = document.getElementById("langSelect");

/* ===== LOGIC ===== */

// 1. Load Known Words for specific language
function loadKnownWords() {
    const key = `knownWords_${currentLang}`;
    const stored = localStorage.getItem(key);
    knownSet = new Set(stored ? JSON.parse(stored) : []);
}

// 2. Save Known Words for specific language
function saveKnownWords() {
    const key = `knownWords_${currentLang}`;
    localStorage.setItem(key, JSON.stringify([...knownSet]));
}

function shuffle(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
    }
}

function rebuildActiveCards() {
    // Get correct dataset
    const data = datasets[currentLang];
    
    // Clamp inputs
    let from = parseInt(fromInput.value);
    let to = parseInt(toInput.value);
    from = Math.max(1, from);
    to = Math.min(data.length, to);
    if (from > to) from = to;

    fromInput.value = from;
    toInput.value = to;

    // Filter cards
    activeCards = data.slice(from - 1, to).filter(c => !knownSet.has(c.q));
    
    index = 0;
    revealed = false;

    if (mode === "random") {
        randomOrder = [...activeCards.keys()];
        shuffle(randomOrder);
    }
    
    showCard();
}

function getCurrentCard() {
    return mode === "random" ? activeCards[randomOrder[index]] : activeCards[index];
}

function showCard() {
    if (activeCards.length === 0) {
        card.textContent = "All Done! ðŸ†";
        answerInput.value = "";
        skipBtn.classList.remove("active");
        return;
    }
    const current = getCurrentCard();
    card.textContent = current.q;
    revealed = false;
    answerInput.value = "";
    
    // Check if user already marked it (edge case)
    if (knownSet.has(current.q)) {
        skipBtn.classList.add("active");
    } else {
        skipBtn.classList.remove("active");
    }
}

/* ===== EVENTS ===== */

/* Language Switch */
langSelect.addEventListener("change", (e) => {
    currentLang = e.target.value;
    loadKnownWords();
    // Reset range to 1-15 for new language or keep user preference? 
    // Let's reset to safe defaults to prevent bugs if lists are different sizes
    fromInput.value = 1;
    toInput.value = Math.min(15, datasets[currentLang].length);
    rebuildActiveCards();
});

/* Card Click */
card.addEventListener("click", () => {
    if (!activeCards.length) return;
    if (!revealed) {
        card.textContent = getCurrentCard().a;
        revealed = true;
    } else {
        index = (index + 1) % activeCards.length;
        showCard();
    }
});

/* Input Logic */
answerInput.addEventListener("keydown", (e) => {
    if (e.key !== "Enter") return;
    if (!activeCards.length) return;

    const current = getCurrentCard();
    const typed = answerInput.value.trim().toLowerCase();
    const correct = current.a.toLowerCase();

    if (typed === correct) {
        // Flash green border for feedback
        answerInput.style.borderColor = "#4caf50";
        setTimeout(() => answerInput.style.borderColor = "#ddd", 500);
        
        index = (index + 1) % activeCards.length;
        showCard();
    } else {
        answerInput.style.borderColor = "#f44336"; // Flash red
        card.textContent = `${current.a} âŒ`;
        revealed = true;
    }
});

/* Skip / Mark Known */
skipBtn.addEventListener("click", () => {
    if (!activeCards.length) return;
    const current = getCurrentCard();

    // Toggle known status
    if (knownSet.has(current.q)) {
        knownSet.delete(current.q);
    } else {
        knownSet.add(current.q);
    }
    
    saveKnownWords();
    rebuildActiveCards();
});

/* Reset */
resetBtn.addEventListener("click", () => {
    if(confirm(`Reset progress for ${currentLang === 'ru' ? 'Russian' : 'Japanese'}?`)) {
        knownSet.clear();
        saveKnownWords();
        rebuildActiveCards();
    }
});

/* Inputs Change */
document.querySelectorAll('input[name="mode"]').forEach(i => {
    i.addEventListener("change", e => { mode = e.target.value; rebuildActiveCards(); });
});
[fromInput, toInput].forEach(i => i.addEventListener("change", rebuildActiveCards));

/* ===== INIT ===== */
loadKnownWords();
rebuildActiveCards();


